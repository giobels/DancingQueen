<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DancingQueen - Dashboard</title>
    <link rel="shortcut icon" href="assets/icon.png">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="fundoModal">
    </div>
    <div class="modal" id="modalNovaCoreo">
        <div class="containerModal">
            <img src="assets/botao-x.png" class="botaoFechar" onclick="fecharModalNovaCoreo()">
            <span>Nova Coreografia</span>
            <div class="inputsModal">
                <div class="inputModal">
                    <span>Nome</span>
                    <input type="text" class="inputCoreo" id="input_coreografia" placeholder="Coreografia">
                </div>
                <div class="inputModal">
                    <span>Categoria</span>
                    <select class="inputCoreo" id="input_categoria">
                        <option disabled selected>Selecione uma categoria</option>
                        <option value="flexibilidade">Flexibilidade</option>
                        <option value="forca">Força</option>
                        <option value="tecnica">Técnica</option>
                        <option value="expressao">Expressão</option>
                    </select>
                </div>
            </div>
            <button class="botaoModal" onclick="novaCoreo()">Criar</button>
        </div>
    </div>

    <div class="modal" id="modalFestival">
        <div class="containerModal">
            <img src="assets/botao-x.png" class="botaoFechar" onclick="fecharModalFestival()">
            <span>Cadastrar Festival</span>
            <div class="inputsModal">
                <div class="inputModal">
                    <span>Festival</span>
                    <input type="text" class="inputCoreo" id="input_festival" placeholder="Nome do festival">
                </div>
                <div class="inputModal">
                    <span>Coreografia</span>
                    <select class="inputCoreo" id="select_coreografia">

                    </select>
                </div>
                <div class="inputModal">
                    <span>Data</span>
                    <input type="date" class="inputCoreo" id="input_datafestival">
                </div>

                <div class="inputModal">
                    <span>Nota</span>
                    <input type="number" class="inputCoreo" id="input_notafestival">
                </div>

            </div>
            <button class="botaoModal" onclick="cadastrarFestival()">Criar</button>
        </div>
    </div>

    <header>
        <nav>
            <ul class="navbar">
                <li class="nav-links"> <img src="assets/logout.png">Sair</li>
                <a href="https://suportedancingqueen.hipporello.net/desk?">
                    <li class="nav-links"> <img src="assets/config.png"> Suporte</li>
                </a>
                <li class="nav-links"> <img src="assets/coroa.png">Dashboard</li>
                <li class="nav-links" onclick="opcaoCoreo1()"> <img src="assets/sapatilha.png">Coreografia</li>
            </ul>
            <img src="assets/bailarina.png">
        </nav>
        <div id="opcaoCoreo">
            <ul id="listOpcaoCoreo">
                <li onclick="abrirModalNovaCoreo()">Nova Coreografia</li>
                <li onclick="abrirModalFestival()">Festival</li>
            </ul>
        </div>
    </header>
    <div class="container">
        <div class="lateral">
            <span id="titulo"></span>

            <div class="kpis">
                <div class="kpi">aaaaa</div>
                <div class="kpi">aaaaa</div>
                <div class="kpi">aaaaa</div>
            </div>
            <div class="container-grafico">
                <canvas id="graficoDesempenho" class="grafico"></canvas>
            </div>

        </div>
        <div class="lateral">
            <div class="container-grafico">
                <canvas id="graficoEvolucao" class="grafico"></canvas>
            </div>
            <div class="container-grafico">
                <span class="titulo-grafico">Análise de Desempenho</span>
                <canvas id="graficoPontuacao" class="grafico"></canvas>
                <br>
                <span class="titulo-select">Coreografia:</span>
                <select id="select_coreoPonto" onchange="obterDadosGrafico()"></select>
            </div>
        </div>
    </div>
</body>

</html>

<!-- <script>
    const labels = [
        'Janeiro',
        'Fevereiro',
        'Março',
        'Abril',
        'Maio',
        'Junho',
    ];

    const data = {
        labels: labels,
        datasets: [{
            label: 'My firt dataset',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: [0, 10, 5, 2, 20, 30, 45],
        },
        {
            label: 'My firt dataset2',
            backgroundColor: 'rgb(132, 99, 255)',
            borderColor: 'rgb(132, 99, 255)',
            data: [10, 20, 15, 12, 30, 40, 55],
        }]
    };

    const config = {
        type: 'bar',
        data: data,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Custom Chart Title'
                }
            }
        }
    };

    const config2 = {
        type: 'radar',
        data: data,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Custom Chart Title'
                }
            }
        }
    };

    const config3 = {
        type: 'line',
        data: data,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Custom Chart Title'
                }
            }
        }
    };

    const graficoDesempenho = new Chart(
        document.getElementById('graficoDesempenho'),
        config)

    const graficoEvolucao = new Chart(
        document.getElementById('graficoEvolucao'),
        config2)

    const graficoPontuacao = new Chart(
        document.getElementById('graficoPontuacao'),
        config3)


</script> -->

<script>

    titulo.innerHTML = `${sessionStorage.NOME_USUARIO}'s Journey`

    let proximaAtualizacao;

    listar();
    obterDadosGrafico();

    let coreopcao = true;
    function opcaoCoreo1() {

        if (coreopcao) {
            opcaoCoreo.style.height = "100px";
            setTimeout(function () { listOpcaoCoreo.style.display = "flex" }, 150);

            coreopcao = false;
        } else {
            opcaoCoreo.style.height = "0px";
            listOpcaoCoreo.style.display = 'none';
            coreopcao = true;
        }

    }

    function novaCoreo() {
        const coreografia = input_coreografia.value.trim();
        const categoria = input_categoria.value.trim();
        const fkUsuario = sessionStorage.ID_USUARIO;

        if (coreografia == '' || categoria == '') {
            alert('Insira uma coreografia a categoria válida.')
        } else {
            fetch("/coreo/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({

                    coreografiaServer: coreografia,
                    categoriaServer: categoria,
                    usuarioServer: fkUsuario,
                }),
            })
            alert('Nova coreografia adicionada!')
        }
    }

    function cadastrarFestival() {
        const festival = input_festival.value.trim();
        const data = input_datafestival.value;
        const nota = input_notafestival.value.trim();
        const coreo = select_coreografia.value;

        if (festival == '' || data == '' || nota == '' || !coreo) {
            alert('Preencha todos os campos para continuar!')
        } else {
            fetch("/festival/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({

                    festivalServer: festival,
                    dataServer: data,
                    notaServer: nota,
                    coreoServer: coreo,

                }),
            })

            alert('Novo Festival adicionado!')

        }

    }

    let listarFirstCall = 0;

    function listar() {
        const fkUsuario = sessionStorage.ID_USUARIO;

        fetch("/coreo/listar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkusuarioServer: fkUsuario,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                let uno = 0;

                resposta.json().then((coreo) => {
                    coreo.forEach((coreografia) => {
                        select_coreografia.innerHTML += `<option value='${coreografia.idCoreografia}'>${coreografia.coreografia}</option>`;

                        if (listarFirstCall == 0) {
                           if(uno ==0){
                               select_coreoPonto.innerHTML = '<option disabled selected>Selecione uma coreografia</option>';
                               uno =1;
                           }
                                select_coreoPonto.innerHTML += `<option value='${coreografia.idCoreografia}'>${coreografia.coreografia}</option>`;
                            
                                var p = coreografia.idCoreografia;
                        }
                    });
                    listarFirstCall = 1;
                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");

            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function abrirModalNovaCoreo() {
        fundoModal.style.display = "block";
        modalNovaCoreo.style.display = "flex";
        opcaoCoreo.style.height = "0px";
        listOpcaoCoreo.style.display = 'none';
        coreopcao = true;
    }

    function fecharModalNovaCoreo() {
        fundoModal.style.display = "none";
        modalNovaCoreo.style.display = "none";
    }

    function abrirModalFestival() {
        select_coreografia.innerHTML = '<option disabled selected>Selecione uma coreografia</option>';
        fundoModal.style.display = "block";
        modalFestival.style.display = "flex";
        opcaoCoreo.style.height = "0px";
        listOpcaoCoreo.style.display = 'none';
        coreopcao = true;
        listar();
    }

    function fecharModalFestival() {
        fundoModal.style.display = "none";
        modalFestival.style.display = "none";
    }


    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico() {
        let fkcoreo = select_coreoPonto.value;

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            cache: 'no-store',
            body: JSON.stringify({
                fkcoreoServer: fkcoreo,
            })
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, fkcoreo);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    let firtsplot = 0;
    function plotarGrafico(resposta, idCoreografia) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Nota',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.data_grafico);
            dados.datasets[0].data.push(registro.nota);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config3 = {
            type: 'line',
            data: dados,
            options: {
                plugins: {
                    // title: {
                    //     display: true,
                    //     text: 'Pontuação '
                    // }
                }
            }
        };

        if (firtsplot == 0) {
            const graficoPontuacao = new Chart(
                document.getElementById('graficoPontuacao'),
                config3)

            firtsplot = 1;
        } else {
            
            let chartStatus = Chart.getChart("graficoPontuacao")
            chartStatus.destroy()

            graficoPontuacao = new Chart(
                document.getElementById('graficoPontuacao'),
                config3)
            }


        // setTimeout(() => atualizarGrafico(idCoreografia, dados, graficoPontuacao), 2000);
    }

    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idCoreografia, dados, graficoPontuacao) {

        // fetch(`/medidas/tempo-real/${idCoreografia}`, { cache: 'no-store' }).then(function (response) {
        //     if (response.ok) {
        //         response.json().then(function (novoRegistro) {

        //             obterdados(idCoreografia);
        //             // alertar(novoRegistro, idAquario);
        //             console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
        //             console.log(`Dados atuais do gráfico:`);
        //             console.log(dados);


        //             if (novoRegistro[0].data_grafico == dados.labels[dados.labels.length - 1]) {
        //                 console.log("---------------------------------------------------------------")
        //                 console.log("Como não há dados novos para captura, o gráfico não atualizará.")
        //                 console.log("Data do novo dado capturado:")
        //                 console.log(novoRegistro[0].data_grafico)
        //                 console.log("Data do último dado capturado:")
        //                 console.log(dados.labels[dados.labels.length - 1])
        //                 console.log("---------------------------------------------------------------")
        //             } else {
        //                 // tirando e colocando valores no gráfico
        //                 dados.labels.shift(); // apagar o primeiro
        //                 dados.labels.push(novoRegistro[0].data_grafico); // incluir um novo momento

        //                 dados.datasets[0].data.shift();  // apagar o primeiro de umidade
        //                 dados.datasets[0].data.push(novoRegistro[0].nota); // incluir uma nova medida de umidade

        //                 graficoPontuacao.update();
        //             }

        //             // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        //             proximaAtualizacao = setTimeout(() => atualizarGrafico(idCoreografia, dados, graficoPontuacao), 2000);
        //         });
        //     } else {
        //         console.error('Nenhum dado encontrado ou erro na API');
        //         // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        //         proximaAtualizacao = setTimeout(() => atualizarGrafico(idCoreografia, dados, graficoPontuacao), 2000);
        //     }
        // })
        //     .catch(function (error) {
        //         console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        //     });

    }

   
</script>